<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DUHIGURE MU MIRYANGO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .dashboard-sidebar {
            background: #2c3e50;
            color: white;
            min-height: calc(100vh - 56px);
            padding: 0;
        }
        .sidebar-nav {
            padding: 1rem 0;
        }
        .nav-item {
            margin: 0;
        }
        .nav-link {
            color: #ecf0f1;
            padding: 12px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: #34495e;
            border-left-color: #3498db;
            color: white;
        }
        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        .dashboard-main {
            background: #f8f9fa;
            min-height: calc(100vh - 56px);
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }
        .stat-icon.primary { background: linear-gradient(45deg, #3498db, #2980b9); }
        .stat-icon.success { background: linear-gradient(45deg, #27ae60, #229954); }
        .stat-icon.warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .stat-icon.info { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .progress-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .duty-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid #dee2e6;
        }
        .duty-item.completed { border-left-color: #28a745; }
        .duty-item.in-progress { border-left-color: #ffc107; }
        .duty-item.pending { border-left-color: #dc3545; }
        .quick-actions {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        .action-btn {
            width: 100%;
            margin-bottom: 0.75rem;
            padding: 12px;
            border-radius: 8px;
            border: none;
            text-align: left;
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            transform: translateX(5px);
        }
        .user-info {
            background: #34495e;
            padding: 1rem;
            border-radius: 0;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        @media (max-width: 768px) {
            .dashboard-sidebar {
                min-height: auto;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/system/dashboard">
                <i class="fas fa-home"></i> DUHIGURE MU MIRYANGO
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="userWelcome">
                    Welcome, <span id="userName">User</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 col-md-4">
                <div class="dashboard-sidebar">
                    <div class="user-info">
                        <div class="d-flex align-items-center">
                            <div class="user-avatar" id="userAvatar">U</div>
                            <div>
                                <h6 class="mb-0" id="userFullName">User Name</h6>
                                <small class="text-muted" id="userRole">Role</small>
                            </div>
                        </div>
                    </div>
                    
                    <nav class="sidebar-nav">
                        <ul class="nav nav-pills flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="/system/dashboard">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/system/family-profile">
                                    <i class="fas fa-users"></i> Family Profile
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/system/members">
                                    <i class="fas fa-user-friends"></i> Family Members
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/system/performance-contract">
                                    <i class="fas fa-file-contract"></i> Performance Contract
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/system/reports">
                                    <i class="fas fa-chart-bar"></i> Reports
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9 col-md-8">
                <div class="dashboard-main p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Dashboard</h2>
                        <div class="text-muted" id="currentDate"></div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card text-center">
                                <div class="stat-icon primary mx-auto">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h4 id="totalFamilies">1</h4>
                                <p class="text-muted mb-0">Total Families</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card text-center">
                                <div class="stat-icon success mx-auto">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                                <h4 id="totalMembers">0</h4>
                                <p class="text-muted mb-0">Family Members</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card text-center">
                                <div class="stat-icon warning mx-auto">
                                    <i class="fas fa-file-contract"></i>
                                </div>
                                <h4 id="totalContracts">0</h4>
                                <p class="text-muted mb-0">Active Contracts</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card text-center">
                                <div class="stat-icon info mx-auto">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h4 id="completionRate">0%</h4>
                                <p class="text-muted mb-0">Completion Rate</p>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="progress-section">
                                <h5 class="mb-3">
                                    <i class="fas fa-tasks"></i> Recent Duties Progress
                                </h5>
                                <div id="recentDuties">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-2">Loading duties...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="quick-actions">
                                <h5 class="mb-3">
                                    <i class="fas fa-bolt"></i> Quick Actions
                                </h5>
                                <button class="btn btn-primary action-btn" onclick="addFamilyMember()">
                                    <i class="fas fa-user-plus"></i> Add Family Member
                                </button>
                                <button class="btn btn-success action-btn" onclick="createContract()">
                                    <i class="fas fa-file-plus"></i> New Contract
                                </button>
                                <button class="btn btn-info action-btn" onclick="updateDuty()">
                                    <i class="fas fa-edit"></i> Update Duty
                                </button>
                                <button class="btn btn-warning action-btn" onclick="viewReports()">
                                    <i class="fas fa-chart-line"></i> View Reports
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Social Media Feed -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="progress-section">
                                <h5 class="mb-3">
                                    <i class="fab fa-twitter"></i> Twitter Updates
                                </h5>
                                <div id="twitterFeed">
                                    <div class="text-muted">
                                        <p>Follow our progress on Twitter @DuhigureRW</p>
                                        <div class="border rounded p-3 mb-2">
                                            <strong>Duhigure RW</strong> @DuhigureRW<br>
                                            <small class="text-muted">2 hours ago</small><br>
                                            Great progress in Kibungo sector! 85% of families have completed their Q1 performance contracts. #Duhigure #Development
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="progress-section">
                                <h5 class="mb-3">
                                    <i class="fab fa-facebook"></i> Facebook Updates
                                </h5>
                                <div id="facebookFeed">
                                    <div class="text-muted">
                                        <p>Connect with us on Facebook</p>
                                        <div class="border rounded p-3 mb-2">
                                            <strong>Duhigure MU MIRYANGO</strong><br>
                                            <small class="text-muted">1 day ago</small><br>
                                            Family training sessions continue! Next session: Agricultural Development Techniques. Register at your local sector office.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadUserInfo();
            loadDashboardData();
            updateDateTime();
            
            // Update time every minute
            setInterval(updateDateTime, 60000);
        });

        async function checkAuthentication() {
            try {
                const response = await fetch('/api/auth/me');
                if (!response.ok) {
                    window.location.href = '/system/login';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/system/login';
            }
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userName').textContent = user.fullName || user.username;
                    document.getElementById('userFullName').textContent = user.fullName || user.username;
                    document.getElementById('userRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
                    document.getElementById('userAvatar').textContent = (user.fullName || user.username).charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    const user = await response.json();
                    
                    if (user.familyId) {
                        // Load family-specific data
                        await loadFamilyData(user.familyId);
                    } else {
                        // Load admin data
                        await loadAdminData();
                    }
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        async function loadFamilyData(familyId) {
            try {
                // Load family members count
                const membersResponse = await fetch(`/api/families/${familyId}/members`);
                if (membersResponse.ok) {
                    const members = await membersResponse.json();
                    document.getElementById('totalMembers').textContent = members.length;
                }

                // Load contracts count
                const contractsResponse = await fetch(`/api/families/${familyId}/contracts`);
                if (contractsResponse.ok) {
                    const contracts = await contractsResponse.json();
                    document.getElementById('totalContracts').textContent = contracts.length;
                    
                    if (contracts.length > 0) {
                        // Load recent duties from the latest contract
                        const latestContract = contracts[0];
                        await loadRecentDuties(latestContract.id);
                    }
                }
                
                document.getElementById('totalFamilies').textContent = 1;
                document.getElementById('completionRate').textContent = '75%'; // Mock data
            } catch (error) {
                console.error('Failed to load family data:', error);
            }
        }

        async function loadAdminData() {
            try {
                // Load all families count
                const familiesResponse = await fetch('/api/families');
                if (familiesResponse.ok) {
                    const families = await familiesResponse.json();
                    document.getElementById('totalFamilies').textContent = families.length;
                }
                
                document.getElementById('totalMembers').textContent = '1,247'; // Mock data
                document.getElementById('totalContracts').textContent = '856'; // Mock data
                document.getElementById('completionRate').textContent = '78%'; // Mock data
                
                // Load mock recent duties for admin view
                loadMockDuties();
            } catch (error) {
                console.error('Failed to load admin data:', error);
            }
        }

        async function loadRecentDuties(contractId) {
            try {
                const dutiesResponse = await fetch(`/api/contracts/${contractId}/member-duties`);
                if (dutiesResponse.ok) {
                    const duties = await dutiesResponse.json();
                    displayRecentDuties(duties.slice(0, 5)); // Show latest 5 duties
                }
            } catch (error) {
                console.error('Failed to load duties:', error);
                loadMockDuties();
            }
        }

        function loadMockDuties() {
            const mockDuties = [
                { duty_title: 'Complete house construction', status: 'in-progress', current_value: '75%', target_value: '100%' },
                { duty_title: 'Install solar panels', status: 'completed', current_value: '100%', target_value: '100%' },
                { duty_title: 'Start vegetable garden', status: 'pending', current_value: '0%', target_value: '100%' },
                { duty_title: 'Register children in school', status: 'completed', current_value: '100%', target_value: '100%' }
            ];
            displayRecentDuties(mockDuties);
        }

        function displayRecentDuties(duties) {
            const container = document.getElementById('recentDuties');
            container.innerHTML = duties.map(duty => `
                <div class="duty-item ${duty.status}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${duty.duty_title}</strong>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar ${duty.status === 'completed' ? 'bg-success' : duty.status === 'in-progress' ? 'bg-warning' : 'bg-danger'}" 
                                     style="width: ${duty.current_value}"></div>
                            </div>
                        </div>
                        <span class="badge ${duty.status === 'completed' ? 'bg-success' : duty.status === 'in-progress' ? 'bg-warning' : 'bg-danger'}">
                            ${duty.status.replace('-', ' ')}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }

        // Quick action functions
        function addFamilyMember() {
            window.location.href = '/system/members';
        }

        function createContract() {
            window.location.href = '/system/performance-contract';
        }

        function updateDuty() {
            alert('Update Duty functionality - Coming soon!');
        }

        function viewReports() {
            window.location.href = '/system/reports';
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/system/login';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }
    </script>
</body>
</html>
